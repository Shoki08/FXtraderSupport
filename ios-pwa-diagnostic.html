<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iOS PWAè¨ºæ–­">
    <title>iOS Safari PWA è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) 20px env(safe-area-inset-left);
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-item.success {
            background: #d4edda;
            border-left: 5px solid #28a745;
        }
        .status-item.error {
            background: #f8d7da;
            border-left: 5px solid #dc3545;
        }
        .status-item.warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        .status-item.info {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
        }
        .label {
            font-weight: 600;
        }
        .value {
            font-family: monospace;
            font-size: 0.9em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        button:active {
            transform: scale(0.98);
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .install-guide {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .install-guide ol {
            margin-left: 20px;
            line-height: 2;
        }
        .emoji {
            font-size: 1.5em;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="emoji">ğŸ</div>
            <h1>iOS Safari PWA è¨ºæ–­</h1>
            <p>iOSã§ã®PWAå‹•ä½œã‚’ãƒã‚§ãƒƒã‚¯</p>
        </div>
        
        <!-- iOSç’°å¢ƒãƒã‚§ãƒƒã‚¯ -->
        <div class="card">
            <h2>ğŸ“± iOSç’°å¢ƒ</h2>
            <div id="ios-check"></div>
        </div>
        
        <!-- PWAæ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯ -->
        <div class="card">
            <h2>âš™ï¸ PWAæ©Ÿèƒ½</h2>
            <div id="pwa-check"></div>
        </div>
        
        <!-- APIæ¥ç¶šãƒ†ã‚¹ãƒˆ -->
        <div class="card">
            <h2>ğŸ”Œ APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testAPIs()">APIã‚’ãƒ†ã‚¹ãƒˆ</button>
            <div id="api-results"></div>
        </div>
        
        <!-- Service WorkerçŠ¶æ…‹ -->
        <div class="card">
            <h2>ğŸ”§ Service Worker</h2>
            <div id="sw-status"></div>
            <button onclick="checkServiceWorker()">çŠ¶æ…‹ã‚’ç¢ºèª</button>
        </div>
        
        <!-- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰ -->
        <div class="card">
            <h2>ğŸ“² ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹æ–¹æ³•</h2>
            <div class="install-guide">
                <ol>
                    <li><strong>å…±æœ‰ã‚¢ã‚¤ã‚³ãƒ³</strong>ã‚’ã‚¿ãƒƒãƒ— <span class="emoji">â¬†ï¸</span></li>
                    <li><strong>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</strong>ã‚’é¸æŠ</li>
                    <li><strong>ã€Œè¿½åŠ ã€</strong>ã‚’ã‚¿ãƒƒãƒ—</li>
                    <li>ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’èµ·å‹•</li>
                </ol>
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>âš ï¸ é‡è¦:</strong> PWAã¨ã—ã¦å‹•ä½œã•ã›ã‚‹ã«ã¯ã€å¿…ãšãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰èµ·å‹•ã—ã¦ãã ã•ã„ã€‚Safariã®ã‚¿ãƒ–ã‹ã‚‰é–‹ãã¨é€šå¸¸ã®Webã‚µã‚¤ãƒˆã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚
                </div>
            </div>
        </div>
        
        <!-- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° -->
        <div class="card">
            <h2>ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h2>
            <div id="troubleshooting"></div>
        </div>
        
        <!-- ãƒ­ã‚° -->
        <div class="card">
            <h2>ğŸ“ è¨ºæ–­ãƒ­ã‚°</h2>
            <div id="log" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <script>
        const log = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            log.unshift({ time: timestamp, message, type });
            updateLog();
            console.log(`[${type}] ${message}`);
        }
        
        function updateLog() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = log.slice(0, 20).map(l => 
                `<div style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; font-size: 0.85em;">
                    <strong>[${l.time}]</strong> ${l.message}
                </div>`
            ).join('');
        }
        
        // iOSç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯
        function checkiOS() {
            const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true || 
                               window.matchMedia('(display-mode: standalone)').matches;
            const hasTouch = 'ontouchstart' in window;
            
            addLog(`iOS: ${isiOS}, Safari: ${isSafari}, Standalone: ${isStandalone}`);
            
            const iosCheck = document.getElementById('ios-check');
            iosCheck.innerHTML = `
                <div class="status-item ${isiOS ? 'success' : 'warning'}">
                    <span class="label">iOSç«¯æœ«</span>
                    <span class="value">${isiOS ? 'âœ… ã¯ã„' : 'âš ï¸ ã„ã„ãˆ'}</span>
                </div>
                <div class="status-item ${isSafari ? 'success' : 'warning'}">
                    <span class="label">Safari</span>
                    <span class="value">${isSafari ? 'âœ… ã¯ã„' : 'âš ï¸ ã„ã„ãˆ'}</span>
                </div>
                <div class="status-item ${isStandalone ? 'success' : 'info'}">
                    <span class="label">ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰</span>
                    <span class="value">${isStandalone ? 'âœ… PWAãƒ¢ãƒ¼ãƒ‰' : 'â„¹ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰'}</span>
                </div>
                <div class="status-item ${hasTouch ? 'success' : 'warning'}">
                    <span class="label">ã‚¿ãƒƒãƒå¯¾å¿œ</span>
                    <span class="value">${hasTouch ? 'âœ… ã¯ã„' : 'âš ï¸ ã„ã„ãˆ'}</span>
                </div>
                <div class="status-item info">
                    <span class="label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</span>
                    <span class="value" style="font-size: 0.75em;">${navigator.userAgent.substring(0, 50)}...</span>
                </div>
            `;
            
            if (!isStandalone) {
                iosCheck.innerHTML += `
                    <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 5px solid #17a2b8;">
                        <strong>â„¹ï¸ ãƒ’ãƒ³ãƒˆ:</strong> ç¾åœ¨ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚<br>
                        PWAæ©Ÿèƒ½ã‚’å®Œå…¨ã«ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãã“ã‹ã‚‰èµ·å‹•ã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
            }
        }
        
        // PWAæ©Ÿèƒ½ã‚’ãƒã‚§ãƒƒã‚¯
        function checkPWAFeatures() {
            const hasServiceWorker = 'serviceWorker' in navigator;
            const hasFetch = typeof fetch !== 'undefined';
            const hasCache = 'caches' in window;
            const hasNotifications = 'Notification' in window;
            const isHTTPS = window.location.protocol === 'https:';
            const hasManifest = document.querySelector('link[rel="manifest"]');
            
            addLog(`PWAæ©Ÿèƒ½: SW=${hasServiceWorker}, Fetch=${hasFetch}, Cache=${hasCache}`);
            
            const pwaCheck = document.getElementById('pwa-check');
            pwaCheck.innerHTML = `
                <div class="status-item ${isHTTPS ? 'success' : 'error'}">
                    <span class="label">HTTPS</span>
                    <span class="value">${isHTTPS ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹ï¼ˆå¿…é ˆï¼‰'}</span>
                </div>
                <div class="status-item ${hasServiceWorker ? 'success' : 'error'}">
                    <span class="label">Service Worker</span>
                    <span class="value">${hasServiceWorker ? 'âœ… ã‚µãƒãƒ¼ãƒˆ' : 'âŒ éã‚µãƒãƒ¼ãƒˆ'}</span>
                </div>
                <div class="status-item ${hasFetch ? 'success' : 'error'}">
                    <span class="label">Fetch API</span>
                    <span class="value">${hasFetch ? 'âœ… ã‚µãƒãƒ¼ãƒˆ' : 'âŒ éã‚µãƒãƒ¼ãƒˆ'}</span>
                </div>
                <div class="status-item ${hasCache ? 'success' : 'warning'}">
                    <span class="label">Cache API</span>
                    <span class="value">${hasCache ? 'âœ… ã‚µãƒãƒ¼ãƒˆ' : 'âš ï¸ éã‚µãƒãƒ¼ãƒˆ'}</span>
                </div>
                <div class="status-item ${hasNotifications ? 'success' : 'warning'}">
                    <span class="label">é€šçŸ¥</span>
                    <span class="value">${hasNotifications ? 'âœ… ã‚µãƒãƒ¼ãƒˆ' : 'âš ï¸ éã‚µãƒãƒ¼ãƒˆ'}</span>
                </div>
                <div class="status-item ${hasManifest ? 'success' : 'warning'}">
                    <span class="label">Manifest</span>
                    <span class="value">${hasManifest ? 'âœ… æ¤œå‡º' : 'âš ï¸ æœªæ¤œå‡º'}</span>
                </div>
            `;
            
            if (!isHTTPS) {
                pwaCheck.innerHTML += `
                    <div class="test-result" style="background: #f8d7da; color: #721c24;">
                        <strong>âŒ ã‚¨ãƒ©ãƒ¼:</strong> HTTPSãŒå¿…è¦ã§ã™ã€‚PWAã¯HTTPSã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚
                    </div>
                `;
            }
        }
        
        // Service WorkerçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            
            if (!('serviceWorker' in navigator)) {
                statusDiv.innerHTML = '<div class="test-result" style="background: #f8d7da;">âŒ Service Workerã¯éã‚µãƒãƒ¼ãƒˆ</div>';
                addLog('Service Workeréã‚µãƒãƒ¼ãƒˆ', 'error');
                return;
            }
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                addLog(`Service Workerç™»éŒ²æ•°: ${registrations.length}`);
                
                if (registrations.length === 0) {
                    statusDiv.innerHTML = `
                        <div class="test-result" style="background: #fff3cd;">
                            â„¹ï¸ Service Workerã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>
                            <small>ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’é–‹ãã¨è‡ªå‹•çš„ã«ç™»éŒ²ã•ã‚Œã¾ã™</small>
                        </div>
                    `;
                } else {
                    let html = '';
                    registrations.forEach((reg, i) => {
                        const state = reg.active ? reg.active.state : 'none';
                        const scope = reg.scope;
                        html += `
                            <div class="test-result" style="background: #d4edda;">
                                âœ… Service Worker ${i + 1}<br>
                                <small>çŠ¶æ…‹: ${state}</small><br>
                                <small>ã‚¹ã‚³ãƒ¼ãƒ—: ${scope}</small>
                            </div>
                        `;
                        addLog(`SW ${i + 1}: ${state}, ${scope}`);
                    });
                    statusDiv.innerHTML = html;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="test-result" style="background: #f8d7da;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                addLog(`Service Workerç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // APIæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆ
        async function testAPIs() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="test-result" style="background: #fff3cd;">ğŸ”„ ãƒ†ã‚¹ãƒˆä¸­...</div>';
            addLog('APIãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            const apis = [
                { name: 'Frankfurter', url: 'https://api.frankfurter.app/latest?from=JPY' },
                { name: 'ExchangeRate-API', url: 'https://api.exchangerate-api.com/v4/latest/JPY' }
            ];
            
            let html = '';
            let successCount = 0;
            
            for (const api of apis) {
                try {
                    addLog(`${api.name} ãƒ†ã‚¹ãƒˆä¸­...`);
                    const start = Date.now();
                    const response = await Promise.race([
                        fetch(api.url),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 8000))
                    ]);
                    const elapsed = Date.now() - start;
                    
                    if (response.ok) {
                        const data = await response.json();
                        const ratesCount = Object.keys(data.rates).length;
                        successCount++;
                        
                        html += `
                            <div class="test-result" style="background: #d4edda;">
                                <strong>âœ… ${api.name}</strong><br>
                                å¿œç­”æ™‚é–“: ${elapsed}ms<br>
                                é€šè²¨æ•°: ${ratesCount}<br>
                                USD/JPY: ${data.rates.USD ? (1/data.rates.USD).toFixed(3) : 'N/A'}
                            </div>
                        `;
                        addLog(`${api.name} æˆåŠŸ (${elapsed}ms)`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    html += `
                        <div class="test-result" style="background: #f8d7da;">
                            <strong>âŒ ${api.name}</strong><br>
                            ã‚¨ãƒ©ãƒ¼: ${error.message}
                        </div>
                    `;
                    addLog(`${api.name} å¤±æ•—: ${error.message}`, 'error');
                }
            }
            
            html = `<div class="test-result" style="background: #d1ecf1;">
                        <strong>çµæœ: ${successCount}/${apis.length} æˆåŠŸ</strong>
                    </div>` + html;
            
            resultsDiv.innerHTML = html;
        }
        
        // ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è¡¨ç¤º
        function showTroubleshooting() {
            const isStandalone = window.navigator.standalone === true || 
                               window.matchMedia('(display-mode: standalone)').matches;
            const troubleshootingDiv = document.getElementById('troubleshooting');
            
            let issues = [];
            
            if (!isStandalone) {
                issues.push({
                    title: 'PWAãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¦ã„ãªã„',
                    solution: 'ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã€ãã“ã‹ã‚‰èµ·å‹•ã—ã¦ãã ã•ã„'
                });
            }
            
            if (window.location.protocol !== 'https:') {
                issues.push({
                    title: 'HTTPSã§ã¯ãªã„',
                    solution: 'HTTPSã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ï¼ˆå¿…é ˆï¼‰'
                });
            }
            
            if (!('serviceWorker' in navigator)) {
                issues.push({
                    title: 'Service Workeréã‚µãƒãƒ¼ãƒˆ',
                    solution: 'iOSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆiOS 11.3ä»¥é™ãŒå¿…è¦ï¼‰'
                });
            }
            
            if (issues.length === 0) {
                troubleshootingDiv.innerHTML = `
                    <div class="status-item success">
                        <span>âœ… å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</span>
                    </div>
                `;
            } else {
                troubleshootingDiv.innerHTML = issues.map(issue => `
                    <div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 5px solid #ffc107;">
                        <strong>âš ï¸ ${issue.title}</strong><br>
                        <span style="font-size: 0.9em;">ğŸ’¡ ${issue.solution}</span>
                    </div>
                `).join('');
            }
        }
        
        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            addLog('è¨ºæ–­ãƒ„ãƒ¼ãƒ«èµ·å‹•');
            checkiOS();
            checkPWAFeatures();
            checkServiceWorker();
            showTroubleshooting();
        });
    </script>
</body>
</html>
